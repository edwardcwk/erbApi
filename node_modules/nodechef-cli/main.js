var cli = require('./cli'),
    fs = require('fs'),
    path = require('path'),
    os = require('os'),
    commands = require('./Commands'),
    cli_version = require('./package.json').version;

var home_dir = null;

if (os.homedir)
    home_dir = os.homedir();
else
    home_dir = /^win/.test(process.platform) ? process.env.USERPROFILE : process.env.HOME;

authfile = path.join(home_dir, 'ncauth.json')

global.__NC_DIR = home_dir;
global.__NC_CLI = 'NodeChef CLI';

cli.blueFont(global.__NC_CLI + ' (' + cli_version + ')'); 

if (fs.existsSync(authfile)) {
    cli.debug('Authentication file [' + authfile + '] exists');
    var filec = fs.readFileSync(authfile, { encoding: 'utf8' });
    cli.debug(filec);

    var apiKey = null;
    try {
        var obj = JSON.parse(filec);
        apiKey = obj.apikey;

        if (apiKey) {
            global.__NC_API_TOKEN = apiKey;
            cli.debug('Using apikey: ' + apiKey);
        }
        else {
            cli.debug('apikey attribute does not exist in auth.json file - Possibly amended by another process');
        }
    }
    catch (e) {
        cli.debug('Failed to retrieve apikey from auth.json file with error: ' + e);
    }
}

process.argv.splice(0, 2);

cli.checkIsLatest(require('./package.json').version, function () {
    if (process.argv.length > 0) {
        var c = process.argv[0].toLocaleLowerCase(), handler = commands[c];
        if (handler) {
            process.argv.splice(0, 1);
            handler(process.argv);
        }
        else {
            cli.writeerror('Unrecognized command [' + c + ']');
        }
    }
});